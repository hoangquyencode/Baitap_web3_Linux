<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Shop Mini ‚Äî beachip.com</title>
<link rel="icon" href="data:,">
<style>
  :root{
    --bg:#f4f7fb; --card:#fff; --muted:#6b7280;
    --accent1:#0366d6; --accent2:#00b7ff; --danger:#e03131;
    --glass: rgba(255,255,255,0.85);
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter, "Segoe UI", Arial; background:var(--bg); color:#0f172a}
  header{position:fixed; left:0;right:0;top:0; height:64px; display:flex; align-items:center; justify-content:space-between; padding:10px 20px; gap:16px;
         background:linear-gradient(90deg,var(--accent1),var(--accent2)); color:#fff; z-index:40; box-shadow:0 6px 20px rgba(2,6,23,0.08)}
  .brand{display:flex;align-items:center;gap:10px;font-weight:700}
  .brand .logo{width:36px;height:36px;border-radius:8px;background:#fff;color:var(--accent1);display:flex;align-items:center;justify-content:center;font-weight:800}
  .searchbox{flex:1;max-width:720px;margin:0 16px;display:flex;gap:8px}
  .searchbox input{flex:1;padding:10px 12px;border-radius:10px;border:none;outline:none}
  .header-actions{display:flex;gap:8px;align-items:center}
  .btn{background:#fff;color:var(--accent1);border:none;padding:9px 14px;border-radius:10px;font-weight:600;cursor:pointer}
  .btn.ghost{background:transparent;color:rgba(255,255,255,0.95);border:1px solid rgba(255,255,255,0.12)}
  .cart-badge{background:var(--danger);color:#fff;border-radius:999px;padding:2px 8px;font-size:12px;margin-left:6px}

  main{padding:100px 24px 60px; max-width:1200px;margin:0 auto}
  .top-panel{display:flex; gap:18px; align-items:flex-start; flex-wrap:wrap}
  .categories{width:220px; background:var(--card); padding:12px;border-radius:12px; box-shadow:0 6px 20px rgba(2,6,23,0.04)}
  .categories h4{margin:0 0 8px}
  .cat-item{padding:8px;border-radius:8px;cursor:pointer;color:var(--accent1);margin-bottom:8px}
  .cat-item.active{background:linear-gradient(90deg,var(--accent1),var(--accent2)); color:#fff}

  .content{flex:1}
  .hero{background:linear-gradient(180deg, rgba(255,255,255,0.7), rgba(255,255,255,0.5)); padding:18px;border-radius:12px; margin-bottom:14px; display:flex; justify-content:space-between; align-items:center}
  .hero h1{margin:0;font-size:20px}
  .hero p{margin:4px 0 0;color:var(--muted)}

  .product-grid{display:grid; grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); gap:14px}
  .product{background:var(--card); padding:12px; border-radius:12px; box-shadow:0 8px 24px rgba(2,6,23,0.04); display:flex; flex-direction:column; gap:8px}
  .product .img{height:140px;border-radius:10px;background:linear-gradient(180deg,#eef6ff,#fdfdff);display:flex;align-items:center;justify-content:center;font-size:22px;color:var(--accent1)}
  .product h3{margin:0;font-size:16px}
  .product p{margin:0;color:var(--muted);font-size:13px}
  .price{font-weight:700;color:var(--accent1)}
  .product .actions{margin-top:auto;display:flex;gap:8px}

  /* cart drawer */
  .drawer{position:fixed;right:0;top:0;height:100%;width:420px;background:var(--card);box-shadow:-10px 0 30px rgba(2,6,23,0.12);transform:translateX(100%);transition:transform .28s ease;z-index:60;padding:18px;display:flex;flex-direction:column;gap:10px}
  .drawer.open{transform:translateX(0)}
  .drawer h3{margin:0}
  .cart-item{display:flex;gap:10px;align-items:center;padding:8px;border-radius:8px}
  .qty{display:flex;gap:6px;align-items:center}
  .qty button{padding:6px 8px;border:none;background:#f1f5f9;border-radius:6px;cursor:pointer}

  /* overlay modal (login/register/checkout) */
  .overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(2,6,23,0.45);z-index:80}
  .overlay.open{display:flex}
  .modal{width:420px;background:var(--card);padding:18px;border-radius:12px;box-shadow:0 8px 40px rgba(2,6,23,0.15)}
  input, textarea, select{width:100%;padding:10px;border-radius:8px;border:1px solid #e6eef7;margin-top:8px;font-size:14px}
  .small{font-size:13px;color:var(--muted)}

  footer{padding:24px;text-align:center;color:var(--muted)}
  @media(max-width:900px){
    .categories{width:100%}
    .top-panel{flex-direction:column}
    .drawer{width:100%}
    .modal{width:92%}
  }
</style>
</head>
<body>

<header>
  <div class="brand">
    <div class="logo">BM</div>
    <div>Shop Mini</div>
  </div>

  <div class="searchbox">
    <input id="searchInput" placeholder="T√¨m ki·∫øm: m√°y, ƒëi·ªán tho·∫°i, tai nghe..." oninput="renderProducts()" />
  </div>

  <div class="header-actions">
    <div id="welcome" style="color:rgba(255,255,255,0.95);font-weight:600"></div>
    <button class="btn ghost" id="adminBtn" style="display:none" onclick="openAdmin()">Admin</button>
    <button class="btn ghost" id="authBtn" onclick="openAuth()">ƒêƒÉng nh·∫≠p</button>
    <button class="btn" id="cartBtn" onclick="toggleCart()">Gi·ªè (<span id="cartCount">0</span>)</button>
  </div>
</header>

<main>
  <div class="top-panel">
    <aside class="categories">
      <h4>Danh m·ª•c</h4>
      <div id="catList"></div>
      <hr style="margin:10px 0">
      <div class="small">B√°n ch·∫°y</div>
      <div id="bestSellerList" style="margin-top:8px"></div>
    </aside>

    <section class="content">
      <div class="hero">
        <div>
          <h1>M√°y t√≠nh ‚Äî ƒêi·ªán tho·∫°i ‚Äî Tai nghe</h1>
          <p class="small">Shop Mini: nhanh ‚Äî r·∫ª ‚Äî uy t√≠n. Mua online, nh·∫≠n h√†ng t·∫≠n n∆°i.</p>
        </div>
        <div style="min-width:180px;text-align:right">
          <div class="small">Giao h√†ng to√†n qu·ªëc</div>
          <div style="margin-top:8px;font-weight:700;color:var(--accent1)">Mi·ªÖn ph√≠ v·∫≠n chuy·ªÉn cho ƒë∆°n > 3.000.000‚Ç´</div>
        </div>
      </div>

      <div id="productGrid" class="product-grid"></div>
    </section>
  </div>
</main>

<!-- Cart Drawer -->
<div class="drawer" id="cartDrawer" aria-hidden="true">
  <div style="display:flex;justify-content:space-between;align-items:center">
    <h3>Gi·ªè h√†ng</h3>
    <div><button class="btn ghost" onclick="toggleCart()">ƒê√≥ng</button></div>
  </div>

  <div id="cartItems" style="overflow:auto;flex:1"></div>

  <div style="border-top:1px solid #eef3fb;padding-top:10px">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div class="small">T·ªïng ti·ªÅn</div>
      <div style="font-weight:800" id="cartTotal">0‚Ç´</div>
    </div>
    <div style="margin-top:10px;display:flex;gap:8px">
      <button class="btn" onclick="checkout()">Thanh to√°n</button>
      <button class="btn ghost" onclick="clearCart()">X√≥a</button>
    </div>
  </div>
</div>

<!-- Overlay Modal (login/register/checkout/admin) -->
<div class="overlay" id="overlay">
  <div class="modal" id="modalContent"></div>
</div>

<footer>¬© Shop Mini ‚Äî beachip.com</footer>

<script>
/* ---------- DATA (sample) ---------- */
const SAMPLE_PRODUCTS = [
  {id: 'pc-1', title: 'Laptop Pro 14"', cat: 'Laptop', price: 27500000, desc: 'CPU i7, RAM 16GB, SSD 512GB', img: 'üíª', sold: 120},
  {id: 'pc-2', title: 'Laptop Air 13"', cat: 'Laptop', price: 18500000, desc: 'CPU i5, RAM 8GB, SSD 256GB', img: 'üñ•Ô∏è', sold: 89},
  {id: 'phone-1', title: 'Phone X Plus', cat: 'ƒêi·ªán tho·∫°i', price: 13900000, desc: '6.5" OLED, 128GB', img: 'üì±', sold: 220},
  {id: 'phone-2', title: 'Phone Mini', cat: 'ƒêi·ªán tho·∫°i', price: 7990000, desc: '5.8" AMOLED, 64GB', img: 'üì±', sold: 158},
  {id: 'head-1', title: 'TrueNoise Earbuds', cat: 'Tai nghe', price: 1990000, desc: 'ANC, 30h playtime', img: 'üéß', sold: 340},
  {id: 'head-2', title: 'Studio Headphones', cat: 'Tai nghe', price: 3590000, desc: 'Over-ear, studio grade', img: 'üéß', sold: 75}
];

const CATEGORIES = ['T·∫•t c·∫£','Laptop','ƒêi·ªán tho·∫°i','Tai nghe'];

/* ---------- STORAGE helpers ---------- */
function money(v){ return v.toLocaleString('vi-VN') + '‚Ç´' }

function setCookie(name, val, days=7){
  const d = new Date(); d.setTime(d.getTime()+days*24*60*60*1000);
  document.cookie = `${name}=${encodeURIComponent(val)};expires=${d.toUTCString()};path=/`;
}
function getCookie(name){
  const m = document.cookie.match(new RegExp('(^| )'+name+'=([^;]+)')); return m? decodeURIComponent(m[2]) : null;
}
function sha256hex(text){ // returns hex string
  const enc = new TextEncoder();
  return crypto.subtle.digest('SHA-256', enc.encode(text)).then(buf=>{
    return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
  });
}

/* ---------- AUTH (tries backend first, else localStorage) ---------- */
async function apiPost(path, body){
  try{
    const headers = {'Content-Type':'application/json'};
    const token = getCookie('session_token'); if(token) headers['Authorization'] = 'Bearer '+token;
    const res = await fetch('/api'+path, {method:'POST', headers, body: JSON.stringify(body)});
    if(!res.ok) throw new Error('no-api');
    return await res.json();
  }catch(e){ throw e; }
}

async function registerRemote(username, passwordHash){
  return await apiPost('/register', {username, passwordHash});
}
async function loginRemote(username, passwordHash){
  return await apiPost('/login', {username, passwordHash});
}

function getLocalUsers(){ return JSON.parse(localStorage.getItem('sm_users')||'{}') }
function setLocalUsers(u){ localStorage.setItem('sm_users', JSON.stringify(u)) }

async function registerLocal(u,p){
  const users = getLocalUsers();
  if(users[u]) throw new Error('exists');
  users[u] = { passwordHash: p, createdAt: Date.now() };
  setLocalUsers(users);
  setCookie('session_user', u, 7);
  sessionStorage.setItem('session_user', u);
  return {ok:true, user:u};
}
async function loginLocal(u,p){
  const users = getLocalUsers();
  if(!users[u] || users[u].passwordHash !== p) throw new Error('invalid');
  setCookie('session_user', u, 7);
  sessionStorage.setItem('session_user', u);
  return {ok:true,user:u};
}

/* ---------- CART ---------- */
function getCart(){ return JSON.parse(localStorage.getItem('sm_cart')||'{}') }
function setCart(c){ localStorage.setItem('sm_cart', JSON.stringify(c)); renderCartCount(); }
function addToCart(id, qty=1){
  const cart = getCart();
  cart[id] = (cart[id]||0) + qty;
  setCart(cart);
  toast('ƒê√£ th√™m v√†o gi·ªè');
}
function clearCart(){ localStorage.removeItem('sm_cart'); renderCart(); renderCartCount(); }

/* ---------- ORDERS (local fallback) ---------- */
function saveOrderLocal(order){
  const arr = JSON.parse(localStorage.getItem('sm_orders')||'[]');
  const id = 'ORD'+Date.now().toString().slice(-6);
  order.id = id; order.createdAt = Date.now();
  arr.unshift(order);
  localStorage.setItem('sm_orders', JSON.stringify(arr));
  return id;
}

/* ---------- UI render ---------- */
function renderCategories(){
  const el = document.getElementById('catList'); el.innerHTML='';
  CATEGORIES.forEach(cat=>{
    const d = document.createElement('div'); d.className='cat-item'; d.textContent=cat;
    d.onclick = ()=>{ currentCategory = cat; document.querySelectorAll('.cat-item').forEach(x=>x.classList.remove('active')); d.classList.add('active'); renderProducts() };
    if(cat==='T·∫•t c·∫£'){ d.classList.add('active') }
    el.appendChild(d);
  });
}

let currentCategory='T·∫•t c·∫£';
function renderProducts(){
  const q = document.getElementById('searchInput').value.trim().toLowerCase();
  const grid = document.getElementById('productGrid'); grid.innerHTML='';
  const filtered = SAMPLE_PRODUCTS.filter(p=>{
    const matchCat = (currentCategory==='T·∫•t c·∫£') || p.cat===currentCategory;
    const matchQ = !q || p.title.toLowerCase().includes(q) || p.desc.toLowerCase().includes(q);
    return matchCat && matchQ;
  });
  filtered.forEach(p=>{
    const card = document.createElement('div'); card.className='product';
    card.innerHTML = `<div class="img">${p.img}</div>
      <h3>${p.title}</h3>
      <p class="small">${p.desc}</p>
      <div class="price">${money(p.price)}</div>
      <div style="display:flex;gap:8px" class="actions">
        <button class="btn" onclick="addToCart('${p.id}',1)">Th√™m</button>
        <button class="btn ghost" onclick="viewDetail('${p.id}')">Xem</button>
      </div>`;
    grid.appendChild(card);
  });
  renderBestSellers();
}

function renderBestSellers(){
  const el = document.getElementById('bestSellerList'); el.innerHTML='';
  const top = SAMPLE_PRODUCTS.slice().sort((a,b)=>b.sold-a.sold).slice(0,3);
  top.forEach(p=>{
    const div = document.createElement('div'); div.style.marginBottom='8px';
    div.innerHTML = `<div style="display:flex;justify-content:space-between"><div>${p.title}</div><div class="small">${money(p.price)}</div></div>`;
    el.appendChild(div);
  });
}

function viewDetail(id){
  const p = SAMPLE_PRODUCTS.find(x=>x.id===id);
  openModal(`<h3>${p.title}</h3><p class="small">${p.desc}</p><p style="font-weight:800">${money(p.price)}</p>
    <div style="margin-top:12px;display:flex;gap:8px"><button class="btn" onclick="addToCart('${p.id}',1);closeModal()">Th√™m v√†o gi·ªè</button><button class="btn ghost" onclick="closeModal()">ƒê√≥ng</button></div>`);
}

/* ---------- Cart UI ---------- */
function renderCart(){
  const items = getCart(); const container = document.getElementById('cartItems'); container.innerHTML='';
  const ids = Object.keys(items);
  if(ids.length===0){ container.innerHTML='<div class="small">Gi·ªè h√†ng tr·ªëng</div>'; document.getElementById('cartTotal').textContent='0‚Ç´'; return; }
  let total=0;
  ids.forEach(id=>{
    const p = SAMPLE_PRODUCTS.find(x=>x.id===id);
    const qty = items[id];
    const row = document.createElement('div'); row.className='cart-item';
    row.innerHTML = `<div style="width:56px;height:56px;border-radius:8px;background:#f6f9ff;display:flex;align-items:center;justify-content:center">${p.img}</div>
      <div style="flex:1">
        <div style="display:flex;justify-content:space-between"><div><strong>${p.title}</strong></div><div class="small">${money(p.price)}</div></div>
        <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
          <div class="qty">
            <button onclick="updateQty('${id}', ${qty-1})">-</button>
            <div style="padding:8px 10px;border-radius:6px;background:#f1f5f9">${qty}</div>
            <button onclick="updateQty('${id}', ${qty+1})">+</button>
          </div>
          <button class="btn ghost" onclick="removeItem('${id}')">X√≥a</button>
        </div>
      </div>`;
    container.appendChild(row);
    total += p.price * qty;
  });
  document.getElementById('cartTotal').textContent = money(total);
}

function renderCartCount(){ const c = Object.values(getCart()).reduce((s,n)=>s+n,0); document.getElementById('cartCount').textContent=c; }

function updateQty(id, val){ if(val<=0){ const c=getCart(); delete c[id]; setCart(c); } else { const c=getCart(); c[id]=val; setCart(c); } renderCart(); }
function removeItem(id){ const c=getCart(); delete c[id]; setCart(c); renderCart(); }

/* ---------- Drawer toggle ---------- */
function toggleCart(){ const d=document.getElementById('cartDrawer'); d.classList.toggle('open'); renderCart(); }

/* ---------- Modal/Overlay ---------- */
function openModal(html){ const o=document.getElementById('overlay'); document.getElementById('modalContent').innerHTML = html; o.classList.add('open'); }
function closeModal(){ document.getElementById('overlay').classList.remove('open'); }
function openAuth(){
  const html = `<h3>ƒêƒÉng nh·∫≠p</h3>
    <div class="small">ƒêƒÉng nh·∫≠p ƒë·ªÉ theo d√µi ƒë∆°n h√†ng v√† thanh to√°n</div>
    <input id="authUser" placeholder="T√™n ƒëƒÉng nh·∫≠p (a-z0-9_-)" />
    <input id="authPass" type="password" placeholder="M·∫≠t kh·∫©u" />
    <div style="display:flex;gap:8px;margin-top:12px">
      <button class="btn" onclick="doLogin()">ƒêƒÉng nh·∫≠p</button>
      <button class="btn ghost" onclick="renderRegister()">ƒêƒÉng k√Ω</button>
    </div>
    <div style="margin-top:10px" class="small">Ho·∫∑c ƒëƒÉng nh·∫≠p b·∫±ng admin: user <strong>admin</strong>, m·∫≠t kh·∫©u <strong>admin123</strong></div>`;
  openModal(html);
}
function renderRegister(){
  const html = `<h3>ƒêƒÉng k√Ω</h3>
    <div class="small">T·∫°o t√†i kho·∫£n m·ªõi</div>
    <input id="regUser" placeholder="T√™n ƒëƒÉng nh·∫≠p (a-z0-9_-)" />
    <input id="regPass" type="password" placeholder="M·∫≠t kh·∫©u (>=6 k√Ω t·ª±)" />
    <input id="regPass2" type="password" placeholder="Nh·∫≠p l·∫°i m·∫≠t kh·∫©u" />
    <div id="regErr" class="small" style="color:#c92a2a"></div>
    <div style="display:flex;gap:8px;margin-top:12px">
      <button class="btn" onclick="doRegister()">T·∫°o</button>
      <button class="btn ghost" onclick="openAuth()">Quay l·∫°i</button>
    </div>`;
  openModal(html);
}

/* ---------- AUTH actions ---------- */
async function doRegister(){
  const u = document.getElementById('regUser').value.trim();
  const p = document.getElementById('regPass').value;
  const p2 = document.getElementById('regPass2').value;
  const errEl = document.getElementById('regErr');
  errEl.textContent='';
  if(!/^[a-z0-9_-]{3,20}$/.test(u)){ errEl.textContent='T√™n kh√¥ng h·ª£p l·ªá (a-z0-9_- , 3-20 k√Ω t·ª±)'; return }
  if(p.length<6){ errEl.textContent='M·∫≠t kh·∫©u qu√° ng·∫Øn'; return }
  if(p!==p2){ errEl.textContent='M·∫≠t kh·∫©u kh√¥ng kh·ªõp'; return }
  const hash = await sha256hex(p);
  // try remote first
  try{
    const res = await registerRemote(u, hash).catch(()=>{throw 'noapi'});
    // expecting {ok:true, token: '...'}
    if(res && res.token){ setCookie('session_token', res.token); setCookie('session_user', u); sessionStorage.setItem('session_user',u); closeModal(); renderHeader(); toast('ƒêƒÉng k√Ω th√†nh c√¥ng'); return }
  }catch(e){
    // fallback local
    try{ await registerLocal(u, hash); closeModal(); renderHeader(); toast('ƒêƒÉng k√Ω l∆∞u local th√†nh c√¥ng') } catch(err){ errEl.textContent = err.message==='exists' ? 'T√™n ƒë√£ t·ªìn t·∫°i' : 'L·ªói ƒëƒÉng k√Ω' }
  }
}

async function doLogin(){
  const u = document.getElementById('authUser').value.trim();
  const p = document.getElementById('authPass').value;
  if(!u || !p){ alert('Nh·∫≠p ƒë·ªß th√¥ng tin'); return }
  const hash = await sha256hex(p);
  // try remote
  try{
    const res = await loginRemote(u, hash).catch(()=>{throw 'noapi'});
    if(res && res.token){ setCookie('session_token', res.token); setCookie('session_user', u); sessionStorage.setItem('session_user',u); closeModal(); renderHeader(); toast('ƒêƒÉng nh·∫≠p th√†nh c√¥ng'); return }
  }catch(e){
    // fallback local
    try{ await loginLocal(u, hash); closeModal(); renderHeader(); toast('ƒêƒÉng nh·∫≠p local th√†nh c√¥ng') } catch(err){ alert('T√†i kho·∫£n ho·∫∑c m·∫≠t kh·∫©u kh√¥ng ƒë√∫ng') }
  }
}

/* ---------- CHECKOUT ---------- */
function checkout(){
  const items = getCart(); if(Object.keys(items).length===0){ alert('Gi·ªè h√†ng r·ªóng'); return }
  const html = `<h3>Thanh to√°n</h3>
    <div class="small">Nh·∫≠p th√¥ng tin giao h√†ng</div>
    <input id="shipName" placeholder="H·ªç t√™n" />
    <input id="shipPhone" placeholder="S·ªë ƒëi·ªán tho·∫°i" />
    <input id="shipAddr" placeholder="ƒê·ªãa ch·ªâ giao h√†ng" />
    <select id="shipMethod"><option value="cod">Thanh to√°n khi nh·∫≠n h√†ng (COD)</option><option value="bank">Chuy·ªÉn kho·∫£n</option></select>
    <div style="display:flex;gap:8px;margin-top:12px">
      <button class="btn" onclick="placeOrder()">ƒê·∫∑t h√†ng</button>
      <button class="btn ghost" onclick="closeModal()">H·ªßy</button>
    </div>`;
  openModal(html);
}

async function placeOrder(){
  const name = document.getElementById('shipName').value.trim();
  const phone = document.getElementById('shipPhone').value.trim();
  const addr = document.getElementById('shipAddr').value.trim();
  const method = document.getElementById('shipMethod').value;
  if(!name || !phone || !addr){ alert('Nh·∫≠p ƒë·ªß th√¥ng tin giao h√†ng'); return }
  const cart = getCart();
  const items = Object.entries(cart).map(([id, qty])=>{
    const p = SAMPLE_PRODUCTS.find(x=>x.id===id);
    return { id, title: p.title, price: p.price, qty };
  });
  const total = items.reduce((s,it)=>s + it.price*it.qty, 0);
  const order = { user: getCookie('session_user')||'guest', name, phone, addr, method, items, total };

  // try send to backend
  try{
    const res = await apiPost('/orders', order).catch(()=>{throw 'noapi'});
    if(res && res.id){ clearCart(); closeModal(); toast('ƒê·∫∑t h√†ng th√†nh c√¥ng. M√£: '+res.id); return }
  }catch(e){
    // fallback: save local
    const id = saveOrderLocal(order);
    clearCart(); closeModal(); toast('ƒê·∫∑t h√†ng l∆∞u local. M√£: '+id);
  }
}

/* ---------- Admin ---------- */
function openAdmin(){
  const cur = sessionStorage.getItem('session_user') || getCookie('session_user');
  if(!cur){ alert('C·∫ßn ƒëƒÉng nh·∫≠p admin'); return }
  if(cur!=='admin'){ alert('Ch·ªâ admin m·ªõi truy c·∫≠p'); return }
  // try fetch orders remote
  (async ()=>{
    try{
      const res = await fetch('/api/admin/orders').then(r=>r.ok? r.json() : Promise.reject('noapi'));
      renderAdminPanel(res);
    }catch(e){
      // load local orders
      const local = JSON.parse(localStorage.getItem('sm_orders')||'[]');
      renderAdminPanel(local);
    }
  })();
}
function renderAdminPanel(orders=[]){
  let html = `<h3>Admin Panel</h3>
    <div class="small">ƒê∆°n h√†ng: ${orders.length}</div>
    <div style="margin-top:8px;max-height:340px;overflow:auto">`;
  orders.forEach(o=>{
    html += `<div style="padding:10px;border-radius:8px;margin-top:8px;background:#fbfcff">
      <div style="display:flex;justify-content:space-between"><div><strong>${o.id||'LOCAL-'+ (o.createdAt? new Date(o.createdAt).toLocaleString() : '')}</strong></div><div class="small">${money(o.total||0)}</div></div>
      <div class="small">KH: ${o.name} ‚Äî ${o.phone}</div>
      <div class="small">ƒê·ªãa ch·ªâ: ${o.addr}</div>
    </div>`;
  });
  html += `</div><div style="margin-top:10px"><button class="btn" onclick="openGrafana()">M·ªü Grafana</button> <button class="btn ghost" onclick="closeModal()">ƒê√≥ng</button></div>`;
  openModal(html);
}
function openGrafana(){
  closeModal();
  const html = `<h3>Grafana</h3><div style="height:400px"><iframe src="/grafana" style="width:100%;height:100%;border:0;border-radius:8px"></iframe></div><div style="margin-top:10px"><button class="btn ghost" onclick="closeModal()">ƒê√≥ng</button></div>`;
  openModal(html);
}

/* ---------- helpers ---------- */
function renderHeader(){
  const user = sessionStorage.getItem('session_user') || getCookie('session_user');
  document.getElementById('authBtn').style.display = user ? 'none' : 'inline-block';
  document.getElementById('adminBtn').style.display = (user==='admin') ? 'inline-block' : 'none';
  document.getElementById('welcome').textContent = user ? `Xin ch√†o, ${user}` : '';
}

function toast(msg){
  // simple alert-like toast
  const el = document.createElement('div'); el.textContent = msg;
  el.style = 'position:fixed;left:50%;transform:translateX(-50%);bottom:30px;background:#0f172a;color:#fff;padding:10px 14px;border-radius:8px;z-index:999';
  document.body.appendChild(el); setTimeout(()=>el.remove(),2500);
}

/* ---------- init ---------- */
(function init(){
  // ensure sample users (admin)
  const us = getLocalUsers();
  if(!us['admin']){ sha256hex('admin123').then(h => { const u2 = getLocalUsers(); u2['admin'] = {passwordHash: h, createdAt: Date.now()}; setLocalUsers(u2); }); }
  renderCategories(); renderProducts(); renderCartCount(); renderHeader();
  // make cart open on load if query param ?cart=1
  const url = new URL(location.href); if(url.searchParams.get('cart')==='1') toggleCart();
})();
</script>
</body>
</html>
